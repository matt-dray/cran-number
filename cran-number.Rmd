---
title: "What's your CRAN number?"
subtitle: 'Extending the Erdos-Bacon-Sabbath concept'
author: "Matt Dray"
date: '`r format(Sys.time(), "%d %B %Y")`'
output:
  html_document:
    theme: cerulean
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, error = FALSE)
```

# Purpose

* [Erdos number](https://en.wikipedia.org/wiki/Erdős_number)
* [Bacon number](https://en.wikipedia.org/wiki/Six_Degrees_of_Kevin_Bacon#Bacon_numbers)
* [Erdos-Bacon number](https://en.wikipedia.org/wiki/Erdős–Bacon_number)

I've used the code written by Francois Keck in his excellent blogpost '[Exploring the CRAN social network](http://www.pieceofk.fr/?p=431)'. His goal was to:

> reconstruct a social graph where each node would be a person... and two persons would be connected by an edge if they have collaborated on the same package

# Prepare workspace

```{r}
library(purrr)
library(stringr)
library(tidyr)
library(dplyr)
library(tictoc)
library(beepr)
```

# Get package authors

At first thought I would have to mine the CRAN website to get all the authors. Then I found out about the `CRAN_package_db()` function, which returns over 60 variables for each package on CRAN (name, version, depends, author, etc).

```{r}
cran_packages <- tools::CRAN_package_db()
```

At time of writing, this results `r nrow(cran_packages)` separate packages.

# Cleaning and preparing

For now we're interested in the authors.

```{r}
cran_authors <- cran_packages$Author
```

The code in this chunk is directly from [Francois](http://www.pieceofk.fr/?p=431). It gets me exactly what I need: a list where each element is a package and contains a vector of authors. Mostly the code replaces inconsequential strings with a bunch of regex and the `stringr` functions. For example, some names in the author field are followed by something like `[aut, cre]`, meaning the person was the package `aut`hor and `cre`ator. Sometimes the names aren't separated easily into a vector because of they contain phrases such as `and` and `with`, which we should also remove.

```{r}
cran_authors_clean <- cran_authors %>%
  # regex to replace unwanted text
  stringr::str_replace_all("\\(([^)]+)\\)", "") %>%
  stringr::str_replace_all("\\[([^]]+)\\]", "") %>%
  stringr::str_replace_all("<([^>]+)>", "") %>%
  stringr::str_replace_all("\n", " ") %>%
  stringr::str_replace_all("[Cc]ontribution.* from|[Cc]ontribution.* by|[Cc]ontributors", " ") %>%
  stringr::str_replace_all("\\(|\\)|\\[|\\]", " ") %>%
  # conversion
  iconv(to = "ASCII//TRANSLIT") %>%
  # further string substitution
  stringr::str_replace_all("'$|^'", "") %>%
  gsub("([A-Z])([A-Z]{1,})", "\\1\\L\\2", ., perl = TRUE) %>%
  gsub("\\b([A-Z]{1}) \\b", "\\1\\. ", .) %>%
  # further string substittion with map()
  purrr::map(stringr::str_split, ",|;|&| \\. |--|(?<=[a-z])\\.| [Aa]nd | [Ww]ith | [Bb]y ", simplify = TRUE) %>%
  purrr::map(stringr::str_replace_all, "[[:space:]]+", " ") %>%
  purrr::map(stringr::str_replace_all, " $|^ | \\.", "") %>%
  purrr::map(function(x) x[stringr::str_length(x) != 0]) %>%
  # reintroduce package names
  purrr::set_names(cran_packages$Package) %>%
  magrittr::extract(map_lgl(., function(x) length(x) > 1))
```

# To dataframe

Turn the list into a two-column tidy dataframe with a row for each package-author relationship.

```{r}
cran_authors_df <- cran_authors_clean %>%  
  tibble::enframe() %>% 
  tidyr::unnest() %>% 
  dplyr::transmute(name = name, author = tolower(value))
```

We can have a quick look at the top authors by count.

```{r}
cran_authors_df %>% 
  janitor::tabyl(author) %>% 
  dplyr::arrange(desc(n)) %>% 
  slice(1:20) %>% 
  knitr::kable()
```

# Graph

```{r}
library(tidygraph)

cran_graph <- tidygraph::as_tbl_graph(cran_authors_df)

cran_graph %>% 
  activate(nodes) %>%
  mutate(id = row_number())
```

```{r}
library(ggraph)

ggraph::ggraph(cran_graph, layout = "nicely") +
  geom_edge_link0(alpha = 0.6) +
  #geom_node_point()
  geom_node_point(alpha = 0.6) +
  theme_graph()
```




Check out [Francois's blogpost](http://www.pieceofk.fr/?p=431) to see some visualisations and network statistics of these data.